<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bright Code Labz — Beta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#0f0f10;--text:#111;--muted:#6b7280;--panel:#fff;--chip:#efeff2;--red:#b91c1c;}
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    .site-header{background:var(--bg-dark);color:#fff;}
    .nav{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:18px}
    .brand{font-weight:700}
    .nav-links{margin-left:auto;display:flex;gap:26px}
    .nav-links a{color:#fff;text-decoration:none;font-weight:600;opacity:.9}
    .nav-links a[aria-current="page"]{background:#fff;color:#111;padding:6px 10px;border-radius:999px}

    .hero{background:var(--bg-dark);color:#fff;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
    .hero-inner{max-width:1100px;margin:0 auto;padding:48px 18px 22px;text-align:center}
    .hero h1{margin:0 0 8px;font-size:40px;letter-spacing:.2px}
    .hero p{margin:0 auto;max-width:820px;color:#d1d5db;font-size:16px;line-height:1.6}
    .hero-actions{display:flex;justify-content:center;gap:12px;margin:18px 0 42px}
    .btn{background:#111;color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.red{background:var(--red)}
    .badge{display:inline-flex;align-items:center;gap:8px;background:var(--chip);color:#222;border-radius:999px;font-size:12px;padding:5px 10px;font-weight:700;margin-left:10px}

    .wrap{max-width:1100px;margin:0 auto 80px;padding:0 18px}
    .card{background:var(--panel);border:1px solid #eee;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08),0 1px 0 rgba(0,0,0,.04);padding:28px}
    .grid{margin-top:22px;display:grid;gap:20px;grid-template-columns:180px 1fr 1fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .left{display:flex;flex-direction:column;gap:14px;align-items:flex-start}
    .hint{font-size:13px;color:#b45309;line-height:1.35}
    .small{font-size:12px;color:var(--muted)}

    .assistant{display:flex;flex-direction:column;gap:14px;align-items:stretch}
    .portrait-wrap{width:100%;max-width:360px;aspect-ratio:3/4;margin-inline:auto;border:1px solid #eee;border-radius:16px;overflow:hidden;background:#f5f5f7}
    .portrait{width:100%;height:100%;object-fit:cover;object-position:top center;display:block}

    .chat{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;align-items:center;background:#fafafa;padding:10px;border:1px solid #e6e6e6;border-radius:14px}
    .para{flex:1;min-height:90px;max-height:220px;resize:vertical;border:none;background:transparent;padding:8px 10px;font-size:16px;line-height:1.5;outline:none}
    .bubble{border:1px solid #e6e6e6;border-radius:14px;padding:12px;background:#fff;color:#222;min-height:54px}
    .kbd{font-size:12px;color:var(--muted)}
    .meta{font-size:12px;color:var(--muted)}

    /* Popups */
    .popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .popup{background:#fff;border-radius:18px;padding:20px;max-width:420px;width:100%;text-align:center;position:relative}
    .circle{width:140px;height:140px;border-radius:50%;background:#000;margin:20px auto;transition:transform 0.18s ease}
    .circle.animate{transform:scale(1.15)}
    .popup-controls{display:flex;justify-content:center;gap:12px;margin-top:16px}

    /* Duo popup */
    .popup-wide{background:#fff;border-radius:18px;padding:20px;max-width:900px;width:96%;text-align:center;position:relative}
    .duo-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:center}
    .mini{width:120px;height:160px;border-radius:12px;border:1px solid #eee;overflow:hidden;margin:0 auto;background:#f5f5f7}
    .mini img{width:100%;height:100%;object-fit:cover;object-position:top center}
    .duo-circles{display:flex;justify-content:space-around;margin-top:8px}
    .duo-circle{width:80px;height:80px;border-radius:50%;background:#000;transition:transform .18s ease}
    .duo-circle.animate{transform:scale(1.15)}
    .duo-controls{display:flex;justify-content:center;gap:12px;margin-top:14px}
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="nav">
      <div class="brand">Bright Code Labz</div>
      <div class="nav-links">
        <a href="/index.html">Home</a>
        <a href="/about.html">About</a>
        <a href="/services.html">Services</a>
        <a href="/portfolio.html">Portfolio</a>
        <a href="/contact.html">Contact</a>
        <a href="/beta.html" aria-current="page">Beta</a>
        <a href="/downloads.html">Downloads</a>
      </div>
    </nav>
  </header>

  <section class="hero">
    <div class="hero-inner">
      <h1>Veya & Orion — Beta <span class="badge" id="qa-count">Q&amp;A loaded</span></h1>
      <p>Each assistant has a paragraph box (Enter to send) and a Live Chat popup for voice. Answers come from <strong>assets/questions.txt</strong> using <strong>{{name}}</strong> placeholders. Unknowns are logged.</p>
      <div class="hero-actions">
        <button class="btn red" id="duoBtn">Duo Chat</button>
      </div>
    </div>
  </section>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <!-- Left tools -->
        <aside class="left">
          <button class="btn" id="checkStatusBtn">What’s new</button>
          <div class="hint" id="writeStatus" aria-live="polite"></div>
          <div class="small">Each click speaks the next update (oldest → newest).</div>
        </aside>

        <!-- VEYA -->
        <section class="assistant" aria-labelledby="veyaTitle">
          <figure class="portrait-wrap">
            <img class="portrait" src="/assets/veya.png" alt="Veya assistant portrait" />
          </figure>
          <h2 id="veyaTitle" class="small" style="margin:0 8px;">Veya</h2>
          <div class="chat">
            <div class="row">
              <textarea id="veyaText" class="para" placeholder="Write to Veya…"></textarea>
              <button class="btn" id="veyaLiveBtn">Start Live Chat</button>
            </div>
            <div class="kbd">Enter = send · Shift+Enter = new line</div>
            <div class="bubble" id="veyaAnswer" aria-live="polite"></div>
            <div class="meta" id="veyaMeta"></div>
          </div>
        </section>

        <!-- ORION -->
        <section class="assistant" aria-labelledby="orionTitle">
          <figure class="portrait-wrap">
            <img class="portrait" src="/assets/orion.png" alt="Orion assistant portrait" />
          </figure>
          <h2 id="orionTitle" class="small" style="margin:0 8px;">Orion</h2>
          <div class="chat">
            <div class="row">
              <textarea id="orionText" class="para" placeholder="Write to Orion…"></textarea>
              <button class="btn" id="orionLiveBtn">Start Live Chat</button>
            </div>
            <div class="kbd">Enter = send · Shift+Enter = new line</div>
            <div class="bubble" id="orionAnswer" aria-live="polite"></div>
            <div class="meta" id="orionMeta"></div>
          </div>
        </section>
      </div>
    </section>
  </main>

  <!-- Solo popups -->
  <div class="popup-overlay" id="veyaPopup" aria-modal="true" role="dialog">
    <div class="popup">
      <div class="circle" id="veyaCircle" aria-hidden="true"></div>
      <div class="popup-controls">
        <button class="btn" id="veyaMute">Mute Mic</button>
        <button class="btn red" id="veyaEnd">End Live Chat</button>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="orionPopup" aria-modal="true" role="dialog">
    <div class="popup">
      <div class="circle" id="orionCircle" aria-hidden="true"></div>
      <div class="popup-controls">
        <button class="btn" id="orionMute">Mute Mic</button>
        <button class="btn red" id="orionEnd">End Live Chat</button>
      </div>
    </div>
  </div>

  <!-- Duo popup -->
  <div class="popup-overlay" id="duoPopup" aria-modal="true" role="dialog">
    <div class="popup-wide">
      <div class="duo-grid">
        <div>
          <div class="mini"><img src="/assets/veya.png" alt="Veya mini" /></div>
          <div class="duo-circles"><div class="duo-circle" id="duoVeya"></div></div>
        </div>
        <div>
          <div class="mini"><img src="/assets/orion.png" alt="Orion mini" /></div>
          <div class="duo-circles"><div class="duo-circle" id="duoOrion"></div></div>
        </div>
      </div>
      <div class="duo-controls">
        <button class="btn" id="duoMute">Mute Mic</button>
        <button class="btn red" id="duoEnd">End Duo Chat</button>
      </div>
    </div>
  </div>

  <script>
    /* ========= helpers ========= */
    function norm(s){return String(s||'').replace(/^\uFEFF/,'').normalize('NFKC').toLowerCase().replace(/\s+/g,' ').trim();}
    function personalize(text, displayName){
      if(!text) return text;
      return text.replace(/\{\{\s*name\s*\}\}/gi, displayName); // placeholder replacement
    }
    function playSound(file,fallbackText,voiceSpeak){
      const audio=new Audio(file);
      audio.onerror=()=>{ if(fallbackText) voiceSpeak(fallbackText); };
      audio.play().catch(()=>{ if(fallbackText) voiceSpeak(fallbackText); });
    }

    /* ========= Q&A ========= */
    const qaMap = new Map();
    async function loadQA(){
      try{
        const res = await fetch('/assets/questions.txt',{cache:'no-store'});
        const txt = await res.text();
        qaMap.clear();
        txt.split(/\r?\n/).forEach(line=>{
          const L=line.replace(/^\uFEFF/,'').trim();
          if(!L || /^#|^\/\//.test(L)) return;
          const i=L.indexOf('=');
          if(i>0) qaMap.set(norm(L.slice(0,i)), L.slice(i+1).trim());
        });
        document.getElementById('qa-count').textContent = qaMap.size+" Q&A loaded";
      }catch(e){ document.getElementById('qa-count').textContent = "Q&A not loaded"; }
    }
    function answerFor(q){ return qaMap.get(norm(q)); }
    async function logUnknown(text){
      try{ await fetch('/log-unknown',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})}); }catch(e){}
    }

    /* ========= Updates ========= */
    const STATUS_KEY='bcl_beta_update_index';
    let updates=[], updateIndex=0;
    async function loadUpdates(){
      try{
        const res = await fetch('/assets/updates.txt',{cache:'no-store'});
        const txt = await res.text();
        updates = txt.split('\n').map(l=>l.trim()).filter(Boolean);
      }catch{ updates = ["No updates file found."]; }
      const saved = parseInt(localStorage.getItem(STATUS_KEY)||'0',10);
      updateIndex = Number.isFinite(saved) && saved>=0 ? Math.min(saved, updates.length) : 0;
    }
    function nextUpdate(speakFn){
      if(!updates.length){ speakFn("No updates available."); return; }
      if(updateIndex < updates.length){
        const t = updates[updateIndex];
        document.getElementById('writeStatus').textContent = t;
        speakFn(t);
        updateIndex++; localStorage.setItem(STATUS_KEY,String(updateIndex));
      }else{
        const end="That's all the updates so far.";
        document.getElementById('writeStatus').textContent=end;
        speakFn(end);
        updateIndex=0; localStorage.setItem(STATUS_KEY,'0');
      }
    }

    /* ========= Voices ========= */
    function makeSpeaker(preferredNames){
      let voice=null;
      function pick(){
        const list = speechSynthesis.getVoices();
        for(const name of preferredNames){
          const v = list.find(x=>x && x.name===name);
          if(v) return v;
        }
        return list.find(v=>/en[-_]/i.test(v.lang)) || list[0] || null;
      }
      function ensure(){ voice = pick(); }
      function speak(text,onend){
        if(!text) return;
        try{ speechSynthesis.resume(); }catch(_){}
        if(speechSynthesis.speaking) speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        if(voice) u.voice = voice;
        u.onend = ()=>{ if(onend) onend(); };
        speechSynthesis.speak(u);
      }
      speechSynthesis.onvoiceschanged = ()=>ensure();
      ensure();
      return { speak };
    }
    // Veya → Ava variants
    const VeyaTTS  = makeSpeaker(["Ava (Premium)","Ava (Enhanced)","Ava"]);
    // Orion → Nathan variants
    const OrionTTS = makeSpeaker(["Nathan (Enhanced)","Nathan"]);

    /* ========= Solo Live Chat ========= */
    function makeLiveChat(opts){
      const {
        popupId, circleId, muteBtnId, endBtnId, startBtnId,
        ttsSpeak, displayName
      } = opts;
      const popup = document.getElementById(popupId);
      const circle = document.getElementById(circleId);
      const muteBtn = document.getElementById(muteBtnId);
      const endBtn  = document.getElementById(endBtnId);
      const startBtn= document.getElementById(startBtnId);

      let recognition=null, muted=false, active=false;
      function animate(on){ circle.classList.toggle('animate', !!on); }

      function buildRec(){
        if(!('webkitSpeechRecognition' in window)) return null;
        const r = new webkitSpeechRecognition();
        r.continuous=false; r.interimResults=false; r.lang="en-US";
        r.onresult = (e)=>{
          const t = e.results[0][0].transcript.trim();
          playSound('/assets/soft_chime.mp3',"Input ended.",ttsSpeak);
          const base = answerFor(t);
          if(base){
            const ans = personalize(base, displayName);
            animate(true); ttsSpeak(ans,()=>{ animate(false); if(active && !muted && recognition){ waitAndListen(); }}); 
          }else{
            const msg="I don't know that yet, I've logged it for the team.";
            logUnknown(t);
            animate(true); ttsSpeak(msg,()=>{ animate(false); if(active && !muted && recognition){ waitAndListen(); }}); 
          }
        };
        return r;
      }
      function waitAndListen(){ playSound('/assets/soft_beep.mp3',"Listening now.",ttsSpeak); try{ recognition.start(); }catch(_e){} }

      startBtn.addEventListener('click', ()=>{
        popup.style.display="flex"; active=true;
        recognition = recognition || buildRec();
        animate(true);
        ttsSpeak(`Hello, I'm ${displayName}. I'm listening now.`, ()=>{ animate(false); if(!muted && recognition){ waitAndListen(); } });
      });
      muteBtn.addEventListener('click', ()=>{
        muted=!muted; muteBtn.textContent = muted?"Unmute Mic":"Mute Mic";
        if(muted && recognition){ try{ recognition.stop(); }catch(_e){} }
        if(!muted && active && recognition){ waitAndListen(); }
      });
      function end(){
        active=false; popup.style.display="none"; animate(false);
        if(recognition){ try{ recognition.stop(); }catch(_e){} }
        try{ speechSynthesis.cancel(); }catch(_e){}
      }
      endBtn.addEventListener('click', end);
      document.addEventListener('keydown', e=>{ if(e.key==="Escape" && active) end(); });
      return { end };
    }

    /* ========= Text boxes ========= */
    function wireText(boxId, outId, metaId, speakFn, displayName){
      const box = document.getElementById(boxId);
      const out = document.getElementById(outId);
      const meta= document.getElementById(metaId);
      function send(){
        const input = box.value.trim();
        if(!input) return;
        const base = answerFor(input);
        if(base){
          const ans = personalize(base, displayName);
          out.textContent = ans; meta.textContent=''; speakFn(ans);
        }else{
          const msg="I don't know that yet, I've logged it for the team.";
          out.textContent = msg; meta.textContent='Tip: add \"question = answer\" to assets/questions.txt';
          speakFn(msg); logUnknown(input);
        }
        box.value='';
      }
      box.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
      return { send };
    }

    /* ========= Duo Chat ========= */
    (function(){
      const duoBtn = document.getElementById('duoBtn');
      const duoPopup = document.getElementById('duoPopup');
      const duoVeya = document.getElementById('duoVeya');
      const duoOrion= document.getElementById('duoOrion');
      const duoMute = document.getElementById('duoMute');
      const duoEnd  = document.getElementById('duoEnd');

      let recognition=null, muted=false, active=false;

      function animate(which,on){
        if(which==='veya') duoVeya.classList.toggle('animate', !!on);
        if(which==='orion') duoOrion.classList.toggle('animate', !!on);
      }

      function buildRec(){
        if(!('webkitSpeechRecognition' in window)) return null;
        const r = new webkitSpeechRecognition();
        r.continuous=false; r.interimResults=false; r.lang="en-US";
        r.onresult = (e)=>{
          const t = e.results[0][0].transcript.trim();
          // Input finished
          playSound('/assets/soft_chime.mp3',null, VeyaTTS.speak);
          // Veya answers, then Orion answers
          const base = answerFor(t);
          const vAns = base ? personalize(base,'Veya') : "I don't know that yet, I've logged it for the team.";
          if(!base) logUnknown(t);

          animate('veya',true);
          VeyaTTS.speak(vAns, ()=>{
            animate('veya',false);
            const oAns = base ? personalize(base,'Orion') : "I don't know that yet, I've logged it for the team.";
            animate('orion',true);
            OrionTTS.speak(oAns, ()=>{
              animate('orion',false);
              if(active && !muted && recognition){ waitAndListen(); }
            });
          });
        };
        return r;
      }
      function waitAndListen(){ playSound('/assets/soft_beep.mp3',null,VeyaTTS.speak); try{ recognition.start(); }catch(_e){} }

      duoBtn.addEventListener('click', ()=>{
        duoPopup.style.display='flex';
        active=true;
        recognition = recognition || buildRec();
        // Greetings: Veya then Orion
        animate('veya',true);
        VeyaTTS.speak("Hello, I'm Veya. We’re both listening.", ()=>{
          animate('veya',false);
          animate('orion',true);
          OrionTTS.speak("And I’m Orion. Ask us anything.", ()=>{
            animate('orion',false);
            if(!muted && recognition){ waitAndListen(); }
          });
        });
      });

      duoMute.addEventListener('click', ()=>{
        muted=!muted; duoMute.textContent = muted ? "Unmute Mic" : "Mute Mic";
        if(muted && recognition){ try{ recognition.stop(); }catch(_e){} }
        if(!muted && active && recognition){ waitAndListen(); }
      });

      function end(){
        active=false; duoPopup.style.display='none';
        animate('veya',false); animate('orion',false);
        if(recognition){ try{ recognition.stop(); }catch(_e){} }
        try{ speechSynthesis.cancel(); }catch(_e){}
      }
      duoEnd.addEventListener('click', end);
      document.addEventListener('keydown', e=>{ if(e.key==="Escape" && active) end(); });
    })();

    /* ========= Wire solo & updates ========= */
    const veyaUI = wireText('veyaText','veyaAnswer','veyaMeta', VeyaTTS.speak, 'Veya');
    const orionUI = wireText('orionText','orionAnswer','orionMeta', OrionTTS.speak, 'Orion');

    makeLiveChat({
      popupId:'veyaPopup', circleId:'veyaCircle',
      muteBtnId:'veyaMute', endBtnId:'veyaEnd', startBtnId:'veyaLiveBtn',
      ttsSpeak: VeyaTTS.speak, displayName:'Veya'
    });
    makeLiveChat({
      popupId:'orionPopup', circleId:'orionCircle',
      muteBtnId:'orionMute', endBtnId:'orionEnd', startBtnId:'orionLiveBtn',
      ttsSpeak: OrionTTS.speak, displayName:'Orion'
    });

    document.getElementById('checkStatusBtn').addEventListener('click', ()=> nextUpdate(VeyaTTS.speak));

    // Init
    loadQA();
    loadUpdates();
  </script>
</body>
</html>
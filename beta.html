<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bright Code Labz — Beta</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg-dark:#0f0f10;--text:#111;--muted:#6b7280;--panel:#fff;--chip:#efeff2;}
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    .site-header{background:var(--bg-dark);color:#fff;}
    .nav{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:18px}
    .brand{font-weight:700}
    .nav-links{margin-left:auto;display:flex;gap:26px}
    .nav-links a{color:#fff;text-decoration:none;font-weight:600;opacity:.9}
    .nav-links a[aria-current="page"]{background:#fff;color:#111;padding:6px 10px;border-radius:999px}

    .hero{background:var(--bg-dark);color:#fff;border-top:1px solid rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.06)}
    .hero-inner{max-width:1100px;margin:0 auto;padding:64px 18px 80px;text-align:center}
    .hero h1{margin:0 0 12px;font-size:40px;letter-spacing:.2px}
    .hero p{margin:0 auto;max-width:820px;color:#d1d5db;font-size:16px;line-height:1.6}

    .wrap{max-width:1100px;margin:32px auto 80px;padding:0 18px}
    .card{background:var(--panel);border:1px solid #eee;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08),0 1px 0 rgba(0,0,0,.04);padding:28px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:var(--chip);color:#222;border-radius:999px;font-size:12px;padding:5px 10px;font-weight:700;margin-left:10px}
    .grid{margin-top:22px;display:grid;gap:20px;grid-template-columns:160px minmax(260px,1fr) minmax(340px,460px);align-items:center}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .left{display:flex;flex-direction:column;gap:14px;align-items:flex-start}
    .btn{background:#111;color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.red{background:#b91c1c}
    .hint{font-size:13px;color:#b45309;line-height:1.35}
    .small{font-size:12px;color:#6b7280}

    .portrait-wrap{width:100%;max-width:420px;aspect-ratio:3/4;margin-inline:auto;align-self:center;justify-self:center;border:1px solid #eee;border-radius:16px;overflow:hidden;background:#f5f5f7}
    .portrait{width:100%;height:100%;object-fit:cover;object-position:top center;display:block}

    .chat{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:8px;align-items:center;background:#fafafa;padding:10px;border:1px solid #e6e6e6;border-radius:14px}
    .para{flex:1;min-height:96px;max-height:220px;resize:vertical;border:none;background:transparent;padding:8px 10px;font-size:16px;line-height:1.5;outline:none}
    .kbd{font-size:12px;color:#6b7280}
    .bubble{border:1px solid #e6e6e6;border-radius:14px;padding:12px;background:#fff;color:#222;min-height:54px}
    .meta{font-size:12px;color:#6b7280}

    /* Live chat popup */
    .popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .popup{background:#fff;border-radius:18px;padding:20px;max-width:420px;width:100%;text-align:center;position:relative}
    .circle{width:140px;height:140px;border-radius:50%;background:#000;margin:20px auto;transition:transform 0.18s ease}
    .circle.animate{transform:scale(1.15)}
    .popup-controls{display:flex;justify-content:center;gap:12px;margin-top:16px}
  </style>
</head>
<body>
  <header class="site-header">
    <nav class="nav">
      <div class="brand">Bright Code Labz</div>
      <div class="nav-links">
        <a href="/index.html">Home</a>
        <a href="/about.html">About</a>
        <a href="/services.html">Services</a>
        <a href="/portfolio.html">Portfolio</a>
        <a href="/contact.html">Contact</a>
        <a href="/beta.html" aria-current="page">Beta</a>
        <a href="/downloads.html">Downloads</a>
      </div>
    </nav>
  </header>

  <section class="hero">
    <div class="hero-inner">
      <h1>Veya — Beta <span class="badge" id="qa-count">Q&amp;A loaded</span></h1>
      <p>Type in the paragraph box and press <strong>Enter</strong> to send, or use the live chat for voice. Answers come from <strong>assets/questions.txt</strong>. Unknowns are logged for the team.</p>
    </div>
  </section>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <!-- Left -->
        <aside class="left">
          <button class="btn" id="checkStatusBtn">What’s new</button>
          <div class="hint" id="writeStatus" aria-live="polite"></div>
          <div class="small">Each click speaks the next update (oldest → newest).</div>
        </aside>

        <!-- Middle -->
        <figure class="portrait-wrap">
          <img class="portrait" src="/assets/veya.png" alt="Veya assistant portrait" />
        </figure>

        <!-- Right -->
        <section class="chat">
          <div class="row">
            <textarea id="askPara" class="para" placeholder="Write to Veya…"></textarea>
            <button class="btn" id="startChatBtn">Start Live Chat</button>
          </div>
          <div class="kbd">Enter = send · Shift+Enter = new line</div>
          <div class="bubble" id="answer" aria-live="polite"></div>
          <div class="meta" id="metaNote"></div>
        </section>
      </div>
    </section>
  </main>

  <!-- Live Chat Popup -->
  <div class="popup-overlay" id="popupOverlay" aria-modal="true" role="dialog">
    <div class="popup">
      <div class="circle" id="voiceCircle" aria-hidden="true"></div>
      <div class="popup-controls">
        <button class="btn" id="muteBtn" aria-pressed="false">Mute Mic</button>
        <button class="btn red" id="endBtn">End Live Chat</button>
      </div>
    </div>
  </div>

  <script>
    /* ================== Speech Synthesis (Samantha) ================== */
    const PREFERRED_VOICE = "Samantha";
    let preferredVoice = null, queuedUtterance = null;

    function pickVoice() {
      const list = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
      return list.find(v => v.name === PREFERRED_VOICE)
          || list.find(v => /en[-_]/i.test(v.lang))
          || list[0] || null;
    }
    function ensureVoiceReady(cb){
      if(!window.speechSynthesis){ cb(); return; }
      const tryPick = () => { preferredVoice = pickVoice(); cb(); };
      const voices = speechSynthesis.getVoices();
      if(voices && voices.length) tryPick();
      else {
        speechSynthesis.onvoiceschanged = () => {
          tryPick();
          if (queuedUtterance) { speechSynthesis.speak(queuedUtterance); queuedUtterance = null; }
        };
      }
    }
    function ssResumeSafe(){ try { speechSynthesis.resume(); } catch(_) {} }

    function speak(text, onend){
      if(!text) return;
      ssResumeSafe();
      if(speechSynthesis.speaking) speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      if(preferredVoice) { u.voice = preferredVoice; if(/Samantha/i.test(preferredVoice.name)) u.lang = "en-US"; }
      u.rate = 1; u.pitch = 1; u.volume = 1;
      u.onstart = () => animateCircle(true);
      u.onend   = () => { animateCircle(false); if(typeof onend === 'function') onend(); };
      const haveVoices = speechSynthesis.getVoices().length > 0;
      if(!haveVoices && !preferredVoice){ queuedUtterance = u; speechSynthesis.getVoices(); }
      else { speechSynthesis.speak(u); }
    }
    ensureVoiceReady(()=>{});
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible') ssResumeSafe(); });

    /* ================== Q&A loader ================== */
    let qaMap = new Map();
    function norm(str){
      return String(str).replace(/^\uFEFF/,'').normalize('NFKC').toLowerCase()
        .replace(/\s+/g,' ').replace(/^[^\w]+|[^\w]+$/g,'').trim();
    }
    async function loadQA(){
      try{
        const res = await fetch('/assets/questions.txt',{cache:'no-store'});
        const raw = await res.text();
        qaMap.clear();
        raw.split(/\r?\n/).forEach(line=>{
          const L = line.replace(/^\uFEFF/,'').trim();
          if(!L || /^#/.test(L) || /^\/\//.test(L)) return;
          const i = L.indexOf('=');
          if(i>0){ qaMap.set(norm(L.slice(0,i)), L.slice(i+1).trim()); }
        });
        document.getElementById('qa-count').textContent = qaMap.size + ' Q&A loaded';
      }catch(e){
        document.getElementById('qa-count').textContent = 'Q&A not loaded';
      }
    }
    function answerFor(q){ return qaMap.get(norm(q)); }

    async function logUnknown(text){
      try{
        await fetch('/log-unknown',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      }catch(_e){}
    }

    /* ================== Text input send ================== */
    function handleSend(){
      const box = document.getElementById('askPara'), input = box.value.trim();
      const out = document.getElementById('answer'), meta = document.getElementById('metaNote');
      if(!input) return;
      const ans = answerFor(input);
      if(ans){ out.textContent = ans; meta.textContent = ''; speak(ans); }
      else { const msg = "I don't know that yet, I've logged it for the team.";
             out.textContent = msg; meta.textContent = 'Tip: add exact “question = answer” to assets/questions.txt';
             speak(msg); logUnknown(input); }
      box.value = '';
    }
    document.getElementById('askPara').addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }
    });

    /* ================== “What’s new” (SPEAK RE-ENABLED) ================== */
    const STATUS_KEY='bcl_beta_update_index';
    let updates=[], updateIndex=0;

    async function loadUpdates(){
      try{
        const res=await fetch('/assets/updates.txt',{cache:'no-store'});
        const txt=await res.text();
        updates=txt.split('\n').map(l=>l.trim()).filter(Boolean);
      }catch{ updates=["No updates file found."]; }
      const saved = parseInt(localStorage.getItem(STATUS_KEY) || '0', 10);
      updateIndex = Number.isFinite(saved) && saved >= 0 ? Math.min(saved, updates.length) : 0;
    }

    function nextUpdate(){
      ssResumeSafe(); // ensure speech can play after user click
      if(!updates.length){ speak("No updates available."); return; }
      if(updateIndex < updates.length){
        const text = updates[updateIndex];
        document.getElementById('writeStatus').textContent = text;
        speak(text);
        updateIndex += 1;
        localStorage.setItem(STATUS_KEY, String(updateIndex));
      }else{
        const end = "That's all the updates so far.";
        document.getElementById('writeStatus').textContent = end;
        speak(end);
        updateIndex = 0;
        localStorage.setItem(STATUS_KEY, '0');
      }
    }
    document.getElementById('checkStatusBtn').addEventListener('click', nextUpdate);

    /* ================== Live chat (soft beep/chime) ================== */
    const popup = document.getElementById('popupOverlay');
    const circle = document.getElementById('voiceCircle');
    const muteBtn = document.getElementById('muteBtn');
    const endBtn  = document.getElementById('endBtn');
    const startBtn= document.getElementById('startChatBtn');

    let recognition = null;
    let muted = false;
    let liveChatActive = false;

    function animateCircle(on){
      if(on===true){ circle.classList.add('animate'); }
      else if(on===false){ circle.classList.remove('animate'); }
      else { circle.classList.add('animate'); setTimeout(()=>circle.classList.remove('animate'), 260); }
    }

    function playSound(file,fallbackText){
      const audio=new Audio(file);
      audio.onerror=()=>{ if(fallbackText) speak(fallbackText); };
      audio.play().catch(()=>{ if(fallbackText) speak(fallbackText); });
    }

    function buildRecognition(){
      if(!('webkitSpeechRecognition' in window)) return null;
      const r = new webkitSpeechRecognition();
      r.continuous = false;
      r.interimResults = false;
      r.lang = "en-US";
      r.onresult = (event)=>{
        const t = event.results[0][0].transcript.trim();
        playSound('/assets/soft_chime.mp3',"Input ended.");
        const ans = answerFor(t);
        if(ans){ speak(ans, ()=>{ if(liveChatActive && !muted && recognition){ waitAndListen(); } }); }
        else { const msg = "I don't know that yet, I've logged it for the team.";
               logUnknown(t);
               speak(msg, ()=>{ if(liveChatActive && !muted && recognition){ waitAndListen(); } }); }
      };
      r.onerror = (_e)=>{};
      r.onend   = ()=>{};
      return r;
    }

    function waitAndListen(){
      playSound('/assets/soft_beep.mp3',"Listening now.");
      try{ recognition.start(); }catch(_e){}
    }

    startBtn.addEventListener('click', ()=>{
      popup.style.display = "flex";
      liveChatActive = true;
      ssResumeSafe();
      ensureVoiceReady(()=>{});
      recognition = recognition || buildRecognition();
      speak("Hello, I'm listening now.", ()=>{ if(!muted && recognition){ waitAndListen(); } });
    });

    muteBtn.addEventListener('click', ()=>{
      muted = !muted;
      muteBtn.textContent = muted ? "Unmute Mic" : "Mute Mic";
      if(muted && recognition){ try{ recognition.stop(); }catch(_e){} }
      if(!muted && liveChatActive && recognition){ waitAndListen(); }
    });

    function endLiveChat(){
      liveChatActive = false;
      popup.style.display = "none";
      if(recognition){ try{ recognition.stop(); }catch(_e){} }
      try{ speechSynthesis.cancel(); }catch(_e){}
      animateCircle(false);
    }
    endBtn.addEventListener('click', endLiveChat);
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && liveChatActive){ endLiveChat(); } });

    /* ================== Init ================== */
    loadQA();
    loadUpdates();
  </script>
</body>
</html>